const state = {
    user: null,
    scope: "all",
    limit: 12,
    offset: 0,
    loading: false,
    reachedEnd: false,
    generating: false,
    currentTweakGameId: null,
};

const PROGRESS_PHRASES = [
    "üß† –ü—Ä–æ–¥—É–º—ã–≤–∞–µ–º –º–µ—Ö–∞–Ω–∏–∫—É —É—Ä–æ–≤–Ω—è...",
    "üé® –î–æ–±–∞–≤–ª—è–µ–º —Å–ø—Ä–∞–π—Ç—ã –∏ —Ñ–æ–Ω...",
    "üéµ –ü–æ–¥–∫–ª—é—á–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –∏ –∑–≤—É–∫...",
    "üïπÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ñ–∏–∑–∏–∫—É...",
    "üß™ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å...",
];

let progressIntervalId = null;
let progressStep = 0;

const decodeCodes = (codes) => String.fromCharCode(...codes);

const routes = {
    games: decodeCodes([47, 97, 112, 105, 47, 103, 97, 109, 101, 115]),
    authSession: decodeCodes([47, 97, 112, 105, 47, 97, 117, 116, 104, 47, 115, 101, 115, 115, 105, 111, 110]),
    authLogin: decodeCodes([47, 97, 112, 105, 47, 97, 117, 116, 104, 47, 108, 111, 103, 105, 110]),
    authLogout: decodeCodes([47, 97, 112, 105, 47, 97, 117, 116, 104, 47, 108, 111, 103, 111, 117, 116]),
    tweakSuffix: decodeCodes([47, 116, 119, 101, 97, 107]),
};

const elements = {
    filters: document.getElementById("filters"),
    chips: Array.from(document.querySelectorAll(".filters .chip")),
    gameList: document.getElementById("game-list"),
    loadMore: document.getElementById("load-more"),
    sessionControls: document.getElementById("session-controls"),
    generatorForm: document.getElementById("generator-form"),
    generatorTextarea: document.getElementById("generator-idea"),
    generatorStatus: document.getElementById("generator-status"),
    generatorSubmit: document.getElementById("generator-submit"),
    modal: document.getElementById("login-modal"),
    modalForm: document.getElementById("login-form"),
    modalCancel: document.getElementById("login-cancel"),
    modalError: document.getElementById("login-error"),
    modalInput: document.getElementById("login-code"),
    tweakModal: document.getElementById("tweak-modal"),
    tweakForm: document.getElementById("tweak-form"),
    tweakCancel: document.getElementById("tweak-cancel"),
    tweakError: document.getElementById("tweak-error"),
    tweakTextarea: document.getElementById("tweak-instructions"),
    tweakTitle: document.getElementById("tweak-title"),
    gameTemplate: document.getElementById("game-card-template"),
};

async function extractErrorMessage(response, fallback = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞") {
    const contentType = response.headers.get("Content-Type") || "";
    if (contentType.includes("application/json")) {
        try {
            const data = await response.json();
            if (data?.message) {
                return data.message;
            }
            if (data?.description) {
                return data.description;
            }
            if (data?.error) {
                return data.error;
            }
        } catch (error) {
            console.debug("error parsing json payload", error);
        }
        return fallback;
    }
    try {
        const text = await response.text();
        return text || fallback;
    } catch (error) {
        console.debug("error reading response body", error);
        return fallback;
    }
}

function formatDate(timestamp) {
    if (!timestamp) {
        return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
    }
    const date = new Date(timestamp * 1000);
    return date.toLocaleString("ru-RU", {
        day: "numeric",
        month: "short",
        hour: "2-digit",
        minute: "2-digit",
    });
}

function formatAuthor(author) {
    if (!author || !author.id) {
        return "–ê–Ω–æ–Ω–∏–º";
    }
    if (author.name) {
        return author.name;
    }
    if (author.username) {
        return `@${author.username}`;
    }
    return `ID ${author.id}`;
}

function showModal() {
    elements.modal.classList.remove("hidden");
    elements.modalError.classList.add("hidden");
    elements.modalInput.value = "";
    setTimeout(() => elements.modalInput.focus(), 50);
}

function hideModal() {
    elements.modal.classList.add("hidden");
}

function showTweakModal(game) {
    state.currentTweakGameId = game.id;
    elements.tweakModal.classList.remove("hidden");
    elements.tweakError.classList.add("hidden");
    elements.tweakTextarea.value = "";
    elements.tweakTitle.textContent = `–ü–æ–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Ä–∞–±–æ—Ç–∫—É (${game.title || "–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"})`;
    setTimeout(() => elements.tweakTextarea.focus(), 50);
}

function hideTweakModal() {
    state.currentTweakGameId = null;
    elements.tweakModal.classList.add("hidden");
}

function setLoading(loading) {
    state.loading = loading;
    elements.loadMore.disabled = loading || state.reachedEnd;
    if (loading) {
        elements.loadMore.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º...";
    } else if (state.reachedEnd) {
        elements.loadMore.textContent = "–≠—Ç–æ –≤—Å—ë";
        elements.loadMore.disabled = true;
    } else {
        elements.loadMore.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë";
    }
}

function startGeneratorProgress(initialMessage = PROGRESS_PHRASES[0]) {
    stopGeneratorProgress();
    if (!elements.generatorStatus) {
        return;
    }
    elements.generatorStatus.classList.remove("error", "success");
    elements.generatorStatus.classList.add("loading");
    elements.generatorStatus.innerHTML = initialMessage;
    const startIndex = PROGRESS_PHRASES.indexOf(initialMessage);
    progressStep = startIndex >= 0 ? startIndex : -1;
    progressIntervalId = window.setInterval(() => {
        if (!elements.generatorStatus) {
            return;
        }
        progressStep = (progressStep + 1) % PROGRESS_PHRASES.length;
        elements.generatorStatus.innerHTML = PROGRESS_PHRASES[progressStep];
    }, 2200);
}

function stopGeneratorProgress() {
    if (progressIntervalId) {
        window.clearInterval(progressIntervalId);
        progressIntervalId = null;
    }
    if (elements.generatorStatus) {
        elements.generatorStatus.classList.remove("loading");
    }
}

function setGenerating(isGenerating, message = "", variant = "info") {
    state.generating = isGenerating;
    if (elements.generatorSubmit) {
        elements.generatorSubmit.disabled = isGenerating;
    }
    if (!elements.generatorStatus) {
        return;
    }
    if (isGenerating) {
        const startingMessage = message || PROGRESS_PHRASES[0];
        startGeneratorProgress(startingMessage);
        return;
    }

    stopGeneratorProgress();
    elements.generatorStatus.classList.remove("error", "success");
    if (message) {
        elements.generatorStatus.innerHTML = message;
    } else {
        elements.generatorStatus.textContent = "";
    }
    if (variant === "error") {
        elements.generatorStatus.classList.add("error");
    } else if (variant === "success") {
        elements.generatorStatus.classList.add("success");
    }
}

function renderSession() {
    elements.sessionControls.innerHTML = "";
    if (state.user) {
        const label = document.createElement("span");
        label.className = "session-label";
        label.textContent = `üëã ${state.user.name || state.user.username || "–ë–µ–∑—ã–º—è–Ω–Ω—ã–π"}`;
        const logoutBtn = document.createElement("button");
        logoutBtn.className = "button ghost";
        logoutBtn.textContent = "–í—ã–π—Ç–∏";
        logoutBtn.addEventListener("click", logout);
        elements.sessionControls.append(label, logoutBtn);
    } else {
        const loginBtn = document.createElement("button");
        loginBtn.className = "button ghost";
        loginBtn.id = "login-button";
        loginBtn.textContent = "–í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É";
        loginBtn.addEventListener("click", showModal);
        elements.sessionControls.append(loginBtn);
    }
}

function renderEmptyState(scope) {
    const article = document.createElement("article");
    article.className = "empty-state";
    article.innerHTML = scope === "mine"
        ? "–ü–æ–∫–∞ —á—Ç–æ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–≥—Ä—É —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—ã—à–µ –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏ –∞–≥–µ–Ω—Ç–∞ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–µ—Å–æ—á–Ω–∏—Ü—É."
        : "–ò–≥—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–∑–∂–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.";
    elements.gameList.append(article);
}

function canTweakGame(game) {
    if (!state.user) {
        return false;
    }
    if (state.user.is_admin) {
        return true;
    }
    const authorId = game?.author?.id;
    if (authorId === null || authorId === undefined) {
        return false;
    }
    const userId = state.user.id;
    if (userId === null || userId === undefined) {
        return false;
    }
    return String(authorId) === String(userId);
}

function renderGames(games, reset = false) {
    if (reset) {
        elements.gameList.innerHTML = "";
    }
    if (games.length === 0 && state.offset === 0) {
        renderEmptyState(state.scope);
        return;
    }
    for (const game of games) {
        const clone = elements.gameTemplate.content.cloneNode(true);
        clone.querySelector(".game-title").textContent = game.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        clone.querySelector(".game-summary").textContent = game.summary || "–û–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ –ø–æ–∑–∂–µ.";
        clone.querySelector(".game-model").textContent = game.model ? `–ú–æ–¥–µ–ª—å: ${game.model}` : "";
        clone.querySelector(".game-author").textContent = `–ê–≤—Ç–æ—Ä: ${formatAuthor(game.author)}`;
        clone.querySelector(".game-time").textContent = formatDate(game.created_at);
        const playLink = clone.querySelector("a.button.primary");
        const shareUrl = game.share_url || `/webapp/sandbox.html?game_id=${encodeURIComponent(game.id)}`;
        playLink.href = shareUrl;
        const copyBtn = clone.querySelector("button[data-copy]");
        copyBtn.addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(shareUrl);
                copyBtn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
                setTimeout(() => (copyBtn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É"), 1500);
            } catch (err) {
                console.error("copy failed", err);
                copyBtn.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å";
                setTimeout(() => (copyBtn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É"), 1500);
            }
        });
        const tweakBtn = clone.querySelector("button[data-tweak]");
        if (tweakBtn) {
            const userCanTweak = canTweakGame(game);
            if (userCanTweak) {
                tweakBtn.addEventListener("click", () => showTweakModal(game));
            } else if (!state.user) {
                tweakBtn.classList.add("locked");
                tweakBtn.textContent = "–í–æ–π—Ç–∏, —á—Ç–æ–±—ã –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å";
                tweakBtn.title = "–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–æ–¥ –∏–∑ –±–æ—Ç–∞, —á—Ç–æ–±—ã –ø—Ä–æ—Å–∏—Ç—å –¥–æ—Ä–∞–±–æ—Ç–∫—É.";
                tweakBtn.addEventListener("click", showModal);
            } else {
                tweakBtn.classList.add("locked");
                tweakBtn.disabled = true;
                tweakBtn.textContent = "–¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä";
                tweakBtn.title = "–¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –∏–≥—Ä—ã –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.";
            }
        }
        elements.gameList.append(clone);
    }
}

async function fetchSession() {
    try {
        const response = await fetch(routes.authSession, { credentials: "same-origin" });
        if (!response.ok) {
            throw new Error("session request failed");
        }
        const data = await response.json();
        state.user = data.authenticated ? data.user : null;
        renderSession();
    } catch (error) {
        console.error("session error", error);
        state.user = null;
        renderSession();
    }
}

async function loadGames({ reset = false } = {}) {
    if (state.loading || (state.reachedEnd && !reset)) {
        return;
    }
    if (reset) {
        state.offset = 0;
        state.reachedEnd = false;
    }
    setLoading(true);
    if (reset) {
        elements.gameList.innerHTML = "<div class=\"spinner\"></div>";
    }
    const params = new URLSearchParams({ limit: String(state.limit), offset: String(state.offset) });
    if (state.scope === "mine") {
        params.set("scope", "mine");
    }
    const response = await fetch(`${routes.games}?${params.toString()}`);
    if (!response.ok) {
        setLoading(false);
        if (response.status === 401 && state.scope === "mine") {
            state.scope = "all";
            updateChips();
            alert("–ù—É–∂–µ–Ω –∫–æ–¥ –æ—Ç –±–æ—Ç–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –∏–≥—Ä—ã.");
            await loadGames({ reset: true });
            return;
        }
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–≥—Ä", response.status);
        return;
    }
    const data = await response.json();
    const items = data.items || [];
    if (reset) {
        elements.gameList.innerHTML = "";
    }
    renderGames(items, false);
    if (items.length < state.limit) {
        state.reachedEnd = true;
    } else {
        state.offset += state.limit;
    }
    setLoading(false);
}

async function login(code) {
    const payload = { code };
    const response = await fetch(routes.authLogin, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        credentials: "same-origin",
    });
    if (!response.ok) {
        const text = await response.text();
        throw new Error(text || "–ö–æ–¥ –Ω–µ –ø–æ–¥–æ—à—ë–ª");
    }
    const data = await response.json();
    state.user = data.user || null;
    renderSession();
}

async function handleGeneratorSubmit(event) {
    event.preventDefault();
    if (state.generating) {
        return;
    }
    const idea = elements.generatorTextarea.value.trim();
    if (!idea) {
        setGenerating(false, "–ù–∞–ø–∏—à–∏, –≤–æ —á—Ç–æ –±—É–¥–µ–º –∏–≥—Ä–∞—Ç—å.", "error");
        return;
    }
    setGenerating(true, PROGRESS_PHRASES[0]);
    try {
        const response = await fetch(routes.games, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idea }),
            credentials: "same-origin",
        });
        if (!response.ok) {
            const fallback = response.status === 401
                ? "–ù—É–∂–µ–Ω –∫–æ–¥ –æ—Ç –±–æ—Ç–∞, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–≥—Ä—ã."
                : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É.";
            const errorMessage = await extractErrorMessage(response, fallback);
            setGenerating(false, errorMessage, "error");
            if (response.status === 401) {
                showModal();
            }
            return;
        }
        const data = await response.json();
        const game = data.game;
        elements.generatorTextarea.value = "";
        const link = game && game.share_url ? `<a href="${game.share_url}">–û—Ç–∫—Ä—ã—Ç—å –∏–≥—Ä—É</a>` : "";
        setGenerating(false, `–ì–æ—Ç–æ–≤–æ! ${game?.title || "–ù–æ–≤–∞—è –∏–≥—Ä–∞"}. ${link}`, "success");
        await loadGames({ reset: true });
    } catch (error) {
        console.error("generate failed", error);
        setGenerating(false, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É. –ü–æ–ø—Ä–æ–±—É–π —É—Ç–æ—á–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏.", "error");
    }
}

async function handleTweakSubmit(event) {
    event.preventDefault();
    if (!state.currentTweakGameId) {
        return;
    }
    const instructions = elements.tweakTextarea.value.trim();
    if (!instructions) {
        elements.tweakError.textContent = "–û–ø–∏—à–∏, —á—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å.";
        elements.tweakError.classList.remove("hidden");
        return;
    }
    elements.tweakError.classList.add("hidden");
    const submitButton = elements.tweakForm.querySelector("button[type=submit]");
    submitButton.disabled = true;
    submitButton.textContent = "–ü—Ä–∏–º–µ–Ω—è–µ–º...";
    try {
        const response = await fetch(
            `${routes.games}/${encodeURIComponent(state.currentTweakGameId)}${routes.tweakSuffix}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ instructions }),
                credentials: "same-origin",
            },
        );
        if (!response.ok) {
            const fallback = response.status === 401
                ? "–ù—É–∂–µ–Ω –∫–æ–¥ –æ—Ç –±–æ—Ç–∞, —á—Ç–æ–±—ã –¥–æ—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏–≥—Ä—ã."
                : response.status === 403
                    ? "–¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –∏–≥—Ä—ã –º–æ–∂–µ—Ç –ø—Ä–æ—Å–∏—Ç—å –¥–æ—Ä–∞–±–æ—Ç–∫—É."
                    : "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–≥—Ä—É.";
            const errorMessage = await extractErrorMessage(response, fallback);
            if (response.status === 401) {
                hideTweakModal();
                showModal();
            } else {
                elements.tweakError.textContent = errorMessage;
                elements.tweakError.classList.remove("hidden");
            }
            return;
        }
        hideTweakModal();
        await loadGames({ reset: true });
    } catch (error) {
        console.error("tweak failed", error);
        elements.tweakError.textContent = "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–≥—Ä—É. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å.";
        elements.tweakError.classList.remove("hidden");
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = "–ü—Ä–∏–º–µ–Ω–∏—Ç—å";
    }
}

async function logout() {
    await fetch(routes.authLogout, { method: "POST", credentials: "same-origin" });
    state.user = null;
    renderSession();
    if (state.scope === "mine") {
        state.scope = "all";
        updateChips();
        await loadGames({ reset: true });
    }
}

function updateChips() {
    elements.chips.forEach((chip) => {
        chip.classList.toggle("active", chip.dataset.scope === state.scope);
    });
}

function handleChipClick(event) {
    const button = event.target.closest("button[data-scope]");
    if (!button) {
        return;
    }
    const nextScope = button.dataset.scope;
    if (nextScope === "mine" && !state.user) {
        showModal();
        return;
    }
    if (state.scope === nextScope) {
        return;
    }
    state.scope = nextScope;
    updateChips();
    loadGames({ reset: true });
}

async function handleLoginSubmit(event) {
    event.preventDefault();
    const rawCode = elements.modalInput.value.trim().toUpperCase();
    if (!rawCode) {
        return;
    }
    elements.modalError.classList.add("hidden");
    elements.modalError.textContent = "";
    const submitButton = elements.modalForm.querySelector("button[type=submit]");
    submitButton.disabled = true;
    submitButton.textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º...";
    try {
        await login(rawCode);
        hideModal();
        state.scope = "mine";
        updateChips();
        await loadGames({ reset: true });
    } catch (error) {
        console.error("login failed", error);
        elements.modalError.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏ –Ω–æ–≤—ã–π —É –±–æ—Ç–∞.";
        elements.modalError.classList.remove("hidden");
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = "–í–æ–π—Ç–∏";
    }
}

function bindEvents() {
    elements.filters.addEventListener("click", handleChipClick);
    elements.loadMore.addEventListener("click", () => loadGames({ reset: false }));
    elements.modalCancel.addEventListener("click", hideModal);
    elements.modalForm.addEventListener("submit", handleLoginSubmit);
    document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
            if (!elements.modal.classList.contains("hidden")) {
                hideModal();
            }
            if (!elements.tweakModal.classList.contains("hidden")) {
                hideTweakModal();
            }
        }
    });
    if (elements.generatorForm) {
        elements.generatorForm.addEventListener("submit", handleGeneratorSubmit);
    }
    if (elements.tweakForm) {
        elements.tweakForm.addEventListener("submit", handleTweakSubmit);
    }
    if (elements.tweakCancel) {
        elements.tweakCancel.addEventListener("click", hideTweakModal);
    }
}

async function bootstrap() {
    bindEvents();
    await fetchSession();
    updateChips();
    await loadGames({ reset: true });
}

bootstrap().catch((error) => {
    console.error("hub bootstrap error", error);
});
